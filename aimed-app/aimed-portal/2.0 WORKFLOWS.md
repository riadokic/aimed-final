
# AIMED Master Workflow (Sovereign Edition v2)

## Objective

Build a production-ready Next.js frontend and n8n backend for **AiMED** — an adaptive medical dictation platform for doctors in Bosnia and Herzegovina. The system prioritizes the  **Sovereign Template Model** , where the AI adapts to the doctor's existing visual identity and report structure, rather than forcing a fixed format. Also, make sure there are error cases as to what happens when for example an empty audio arrives.

---

## 1. Core Concept: The Sovereign Template System

Unlike generic dictation tools, AiMED treats medical reports as a collection of **Dynamic Slots** within a doctor's personal layout.

* **Adaptive Structure** : The system recognizes any placeholder (e.g., `{{tenzija}}`, `{{p_art}}`, `{{nalaz_uzv}}`) by analyzing the surrounding HTML context.
* **Hybrid Source** : The report is a fusion of existing patient data (from uploaded PDFs/images via OCR) and new vocal input.
* **Zero-Habit Change** : The final output looks exactly like the doctor’s current paper/Word report.

---

## 2. Backend API Spec (n8n Workflows)

### A. Transcription & Mapping (`AIMED-transcribe`)

**Endpoint:** `POST /webhook/AIMED-transcribe`

| **Field**   | **Type** | **Description**                                              |
| ----------------- | -------------- | ------------------------------------------------------------------ |
| `audio`         | Binary         | Recorded dictation.                                                |
| `doctor_id`     | String         | Used to fetch personal templates and metadata from Supabase.       |
| `existing_data` | JSON           | (Optional) Data extracted from OCR of an uploaded previous report. |

**Processing Pipeline:**

1. **Fetch Template** : n8n pulls `fields_metadata` (mapping keys + inferred meanings) for the specific doctor.
2. **Whisper Transcribe** : Converts audio to text (language: `hr/bs`).
3. **Claude Hybrid Mapping** :

* **Input** : Raw Transcript + `existing_data` (OCR) + Metadata Keys.
* **Action** : Claude maps findings to keys.
* **Retention Rule** : Claude **MUST** preserve administrative info (Patient Name, Protocol #, DOB) found in `existing_data` or the template context, even if not explicitly dictated.

1. **Response** : Returns structured JSON of all populated key-value pairs.

### B. Document Export (`AIMED-export`)

**Endpoint:** `POST /webhook/AIMED-export`

**Logic:**

1. **Fetch Raw HTML** : n8n retrieves the doctor's `raw_html` template from Supabase.
2. **Placeholder Injection** : A Code Node executes a global regex replace, swapping `{{key}}` with finalized text.
3. **Render** : Generates a PDF via PDFShift.

---

## 3. Frontend Architecture (The Dynamic UI)

### Tech Stack

* **Framework** : Next.js 15 (App Router)
* **Database** : Supabase (Auth, `doctor_templates`, `usage_metrics`)
* **State** : React Hook Form + Dynamic Mapping

### Sovereign Features

1. **Template Manager** : Interface for doctors to upload HTML and define placeholders.
2. **Dynamic Form Engine** : The page `.map()`s through `fields_metadata` to generate editing fields.
3. **Adaptive Persistence** : The UI displays recognized personal info (e.g., "JUSUPOVIĆ NURIJA") immediately if found in the template context.
4. **Amber Badge Feedback** : Visual indicators for fields newly changed by AI.

---

## 4. Build Phases

### Phase 1: Data & Metadata (Supabase)

* [ ] Create `doctor_templates` table (`id`, `doctor_id`, `raw_html`, `fields_metadata`).
* [ ] **AI Discovery Script** : Tool that analyzes HTML and "guesses" placeholder meanings (e.g., `{{ta}}` is "Tenzija/Pritisak").

### Phase 2: Dynamic n8n Workflows

* [ ] **Refactor Transcribe** : Move to a metadata-driven prompt that accepts `existing_data`.
* [ ] **Hybrid Prompting** : Update Claude to: *"Popuni JSON. Ako vidiš podatke u existing_data (npr. Ime), zadrži ih. Ako audio sadrži izmjene, ažuriraj polje. Vrati SVE prepoznate ključeve."*
* [ ] **Export Logic** : Build the HTML-to-PDF injection node.

### Phase 3: The "Sovereign" UI

* [ ] **Dynamic Report Editor** : Form that generates fields based on fetched metadata.
* [ ] **Contextual Display** : Logic to show patient identifiers recognized from the template/OCR even if not dictated.

---

## 5. Security & GDPR (BiH Compliance)

* **Zero Retention** : Audio and raw transcripts discarded immediately after execution.
* **In-Transit Privacy** : Identifiers are processed only within the ephemeral n8n execution context to populate the template.
* **Consent Enforcement** : Non-bypassable GDPR modal for every new doctor session.

---

## 6. Implementation Strategy for Claude Code

### Step 1: Semantic Discovery

Claude implements a function taking raw HTML and returning a schema:

**JSON**

```
{
  "placeholders": [
    { "key": "pacijent_ime", "meaning": "Ime i prezime pacijenta", "type": "text" },
    { "key": "lvef", "meaning": "Istisna frakcija lijeve komore", "type": "measurement" }
  ]
}
```

### Step 2: n8n Workflow Update

Claude edits `AIMED-transcribe.json` and `AIMED-export.json` to:

1. Handle dynamic metadata and `existing_data` inputs.
2. Inject all keys into the `Prepare Template Data` node.

### Step 3: Localhost Testing & QA

* **Test A** : Upload Cardio PDF (JUSUPOVIĆ NURIJA) -> Dictate "LVEF je 50" -> Export.
* **Result** : PDF must show "JUSUPOVIĆ NURIJA" and updated LVEF.

---

## 7. Success Criteria

* Doctors use **their own** layout.
* AI populates **all** fields (Admin + Medical) accurately.
* UI displays recognized personal info automatically from context.
