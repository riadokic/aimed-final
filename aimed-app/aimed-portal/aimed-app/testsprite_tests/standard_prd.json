{
  "meta": {
    "project": "AIMED (AI Medical Dictation)",
    "date": "2026-02-15",
    "prepared_by": "Generated by TestSprite"
  },
  "product_overview": "AIMED is a Next.js web app that lets doctors dictate medical reports, receives AI-formatted report text from an n8n/OpenAI pipeline, and provides local-first editing and export (PDF/Word) while enforcing GDPR requirements.",
  "core_goals": [
    "Enable doctors to record audio dictation and receive structured, editable medical reports",
    "Keep medical content local-first and GDPR-compliant (no raw audio/transcript retention in the cloud)",
    "Support three report modes: New, Existing-Update, and Template-based",
    "Provide Supabase auth, onboarding, patient management, and secure settings",
    "Allow export to print-ready PDF and Word and quick copy for HIS systems"
  ],
  "features": [
    {
      "name": "Email Registration",
      "description": "Allow new doctors to register with name, specialization, clinic and explicit GDPR consent; sends confirmation email.",
      "user_flows": [
        "Navigate to /registracija -> Fill full name input -> Fill specialization input -> Fill clinic name input -> Fill email input -> Fill password input -> Fill confirm password input -> Check GDPR consent checkbox -> Click \"Registrujte se\" button -> See success screen with \"Provjerite email\" message",
        "Navigate to /registracija -> Fill full name input -> Fill email input -> Fill password input -> Fill confirm password input (mismatch) -> Click \"Registrujte se\" button -> See inline error 'Password confirmation does not match'",
        "Navigate to /registracija -> Fill full name input -> Fill specialization input -> Fill clinic name input -> Fill email input -> Fill password input -> Fill confirm password input -> Leave GDPR consent unchecked -> Click \"Registrujte se\" button -> See error blocking registration about required GDPR consent"
      ]
    },
    {
      "name": "Email Login",
      "description": "Authenticate returning users with email and password and redirect to dashboard on success.",
      "user_flows": [
        "Navigate to /login -> Fill email input -> Fill password input -> Click \"Prijavite se\" button -> Redirect to /dashboard on success",
        "Navigate to /login -> Fill email input -> Fill password input (wrong) -> Click \"Prijavite se\" button -> See error on invalid credentials"
      ]
    },
    {
      "name": "Google OAuth Login",
      "description": "Allow login or registration using Google OAuth and handle the OAuth callback to create a session.",
      "user_flows": [
        "Navigate to /login -> Click \"Prijavi se putem Google-a\" button -> Google consent screen opens -> Approve consent -> Redirect to /auth/callback -> Redirect to /dashboard on success",
        "Navigate to /login -> Click \"Prijavi se putem Google-a\" button -> Google consent screen opens -> Decline or close consent -> Return to /login and see authentication error or unchanged state"
      ]
    },
    {
      "name": "Email Confirmation Flow",
      "description": "Handle email confirmation links which exchange a code for a session and route new users into onboarding.",
      "user_flows": [
        "Click confirmation link in email -> Navigate to /auth/callback -> Auth callback exchanges code for session -> Automatically redirected to /dashboard -> Onboarding wizard appears for new users",
        "Click expired/invalid confirmation link in email -> Navigate to /auth/callback -> See error message about invalid or expired link -> Navigate to /login or request a new confirmation email"
      ]
    },
    {
      "name": "Onboarding Wizard",
      "description": "Multi-step modal shown to newly confirmed users to collect doctor info, clinic info, report categories, and optional branding uploads.",
      "user_flows": [
        "Navigate to /dashboard (new user) -> See onboarding wizard modal appear -> Step 1 - Fill doctor name and specialization (required) -> Click Next -> Step 2 - Optionally fill clinic name, address, phone, website -> Click Skip -> Step 3 - Add at least one report category -> Click Next -> Step 4 - Optionally upload logo, stamp, signature images -> Click \"Završi\" to complete onboarding -> See dashboard with onboarding completed",
        "Navigate to /dashboard (new user) -> See onboarding wizard modal appear -> Step 1 - Leave mandatory doctor name empty -> Click Next -> Stay on Step 1 and see validation error for required fields"
      ]
    },
    {
      "name": "Password Reset",
      "description": "Request a password reset email and set a new password via emailed link.",
      "user_flows": [
        "Navigate to /reset-password -> Fill email input -> Click reset button -> See confirmation that reset email was sent -> Click link in received email -> Set new password -> See confirmation of password update",
        "Navigate to /reset-password -> Fill email input that is not registered -> Click reset button -> See non-specific confirmation or error indicating no account found (without leaking account existence)"
      ]
    },
    {
      "name": "Dashboard",
      "description": "Authenticated landing space showing report statistics, recent reports, and quick actions to create reports, open patients, or go to settings.",
      "user_flows": [
        "Navigate to /dashboard -> See report count and statistics displayed -> Click recent report item -> Navigate to report detail view (in-app) or open editor",
        "Navigate to /dashboard -> Authenticated session expired -> See a redirect to /login or an inline session error prompting re-login"
      ]
    },
    {
      "name": "New Medical Report (Dictation) - New / Update / Template Modes",
      "description": "Record audio dictation, send audio to the n8n webhook, receive structured report text, allow edits, and support update and template modes.",
      "user_flows": [
        "Navigate to /novi-nalaz -> Click record button to start audio recording -> Speak medical dictation -> Click stop to end recording -> See processing state with skeleton loader -> Wait for transcription processing -> Review and edit generated report sections -> Click Export as PDF -> Receive/download PDF file",
        "Navigate to /novi-nalaz -> Click record button to start audio recording -> Browser prompts for microphone permission -> Deny microphone permission -> See error 'Microphone access blocked' and recording disabled",
        "Navigate to /novi-nalaz -> Click upload existing report button -> Select PDF/Word file -> File is parsed and extracted text is shown as \"existing_report\" -> Click record button and dictate changes -> Click stop to end recording -> See processing state -> Wait for transcription processing -> Receive updated report with amber badge indicating update mode -> Review changes",
        "Navigate to /novi-nalaz -> Select previously uploaded template from Settings or upload template now -> Click record button and dictate content for placeholders -> Click stop to end recording -> See processing state -> Wait for transcription processing -> Receive report populated into template placeholders -> Review and export",
        "Navigate to /novi-nalaz -> Click record button to start audio recording -> Speak dictation -> Click stop to end recording -> See processing state -> n8n/API times out or returns error -> See friendly error 'API timeout' with retry option"
      ]
    },
    {
      "name": "Report History",
      "description": "List and search past reports stored locally (or in DB depending on phase) with filters and detail view.",
      "user_flows": [
        "Navigate to /historija -> See list of past reports displayed -> Use search input to type patient name or content -> See filtered list of reports -> Click a report to view details",
        "Navigate to /historija -> Use search input with a term that matches no reports -> See 'No results found' state and suggestion to clear filters"
      ]
    },
    {
      "name": "Patient Management",
      "description": "Create and manage patient records (add, edit, view) to attach to reports locally or in Supabase after future integration.",
      "user_flows": [
        "Navigate to /pacijenti -> See patient list -> Click add new patient -> Fill patient form (name, date of birth, contact) -> Click Save patient -> See new patient in list",
        "Navigate to /pacijenti -> Click add new patient -> Fill invalid date of birth or required field missing -> Click Save patient -> See inline validation error and prevent save"
      ]
    },
    {
      "name": "Settings (Doctor, Clinic, Report Categories, Branding, Account)",
      "description": "Manage user profile, clinic details, report categories ordering, upload branding assets (logo, stamp, signature), and account deletion.",
      "user_flows": [
        "Navigate to /postavke -> Edit doctor name and specialization -> Click Save -> See confirmation that profile was updated",
        "Navigate to /postavke -> Add/remove/reorder report categories -> Click Save -> See updated categories reflected in New Report wizard and Onboarding",
        "Navigate to /postavke -> Upload logo, stamp, signature images -> Click Save -> See uploaded assets preview and confirmation",
        "Navigate to /postavke -> Click Delete account -> Confirm deletion in modal -> Account is deleted and user is redirected to / (landing) or /registracija",
        "Navigate to /postavke -> Click Delete account -> Cancel in confirmation modal -> Remain on /postavke with account intact"
      ]
    },
    {
      "name": "Export & Copy (PDF, Word, HIS Copy)",
      "description": "Export finalized reports to print-ready PDF, generate Word (.docx) using templates, and provide a cleaned text copy for HIS systems.",
      "user_flows": [
        "Open a finalized report (from /novi-nalaz or history) -> Click Export as PDF -> Client generates PDF via html2pdf.js -> Prompt to download PDF file",
        "Open a finalized report with a stored .docx template -> Click Export as Word -> Generate .docx populated with placeholders using docx library -> Prompt to download .docx file",
        "Open a finalized report -> Click Copy for HIS system -> See 'Copied!' feedback (2s) -> Pasted text contains filtered sections without internal [NAPOMENA] warnings",
        "Open a finalized report -> Click Export as PDF -> Client-side PDF generator fails or browser blocks download -> See friendly error 'Export failed' with retry option"
      ]
    },
    {
      "name": "Protected Route Middleware",
      "description": "Middleware enforces authentication: redirect unauthenticated users to /login and prevents authenticated users from accessing public auth routes.",
      "user_flows": [
        "Navigate to /novi-nalaz without authentication -> Middleware intercepts -> Redirect to /login",
        "Navigate to /login while already authenticated -> Middleware intercepts -> Redirect to /dashboard",
        "Navigate to /auth/callback during OAuth flow -> Middleware allows route -> Auth callback completes and redirects appropriately"
      ]
    },
    {
      "name": "GDPR Consent & Data Deletion",
      "description": "Enforce explicit GDPR consent before using AI services and provide a one-click local data deletion to clear all local medical content and consent state.",
      "user_flows": [
        "First-time app load -> GDPR consent modal blocks app usage -> Read consent details -> Click Accept -> Consent stored in localStorage with timestamp -> Access app features",
        "First-time app load -> GDPR consent modal blocks app usage -> Click Decline or close modal -> App remains blocked from recording and processing",
        "Navigate to /postavke -> Click 'Obriši sve moje podatke' -> Confirm deletion in modal -> localStorage is cleared, local reports removed, consent cleared -> See app returned to initial onboarding/consent state"
      ]
    }
  ],
  "code_summary": {
    "version": "2",
    "type": "frontend",
    "tech_stack": [
      "TypeScript",
      "Next.js 16 (App Router)",
      "Tailwind CSS",
      "Supabase (Auth + Database + Storage)",
      "html2pdf.js (PDF export)",
      "docx (Word export)"
    ],
    "routes": [
      {
        "path": "/",
        "file": "src/app/page.tsx",
        "auth_required": false,
        "description": "Landing page with hero, features, pricing, FAQ"
      },
      {
        "path": "/login",
        "file": "src/app/(auth)/login/page.tsx",
        "auth_required": false,
        "description": "Email/password and Google OAuth login"
      },
      {
        "path": "/registracija",
        "file": "src/app/(auth)/registracija/page.tsx",
        "auth_required": false,
        "description": "New user registration with email, password, name, specialization, clinic, GDPR consent"
      },
      {
        "path": "/reset-password",
        "file": "src/app/(auth)/reset-password/page.tsx",
        "auth_required": false,
        "description": "Password reset flow"
      },
      {
        "path": "/auth/callback",
        "file": "src/app/auth/callback/route.ts",
        "auth_required": false,
        "description": "OAuth and email confirmation callback - exchanges code for session"
      },
      {
        "path": "/dashboard",
        "file": "src/app/dashboard/page.tsx",
        "auth_required": true,
        "description": "Main dashboard with report stats, recent reports, quick actions"
      },
      {
        "path": "/novi-nalaz",
        "file": "src/app/novi-nalaz/page.tsx",
        "auth_required": true,
        "description": "New medical report - audio dictation recording and report generation"
      },
      {
        "path": "/historija",
        "file": "src/app/historija/page.tsx",
        "auth_required": true,
        "description": "Report history list with search and filters"
      },
      {
        "path": "/pacijenti",
        "file": "src/app/pacijenti/page.tsx",
        "auth_required": true,
        "description": "Patient management - list, add, edit patients"
      },
      {
        "path": "/postavke",
        "file": "src/app/postavke/page.tsx",
        "auth_required": true,
        "description": "Settings - doctor info, clinic info, report categories, branding uploads, account deletion"
      },
      {
        "path": "/politika-privatnosti",
        "file": "src/app/politika-privatnosti/page.tsx",
        "auth_required": false,
        "description": "Privacy policy page"
      },
      {
        "path": "/uslovi-koristenja",
        "file": "src/app/uslovi-koristenja/page.tsx",
        "auth_required": false,
        "description": "Terms of service page"
      },
      {
        "path": "/gdpr-sigurnost",
        "file": "src/app/gdpr-sigurnost/page.tsx",
        "auth_required": false,
        "description": "GDPR security information page"
      }
    ],
    "features": [
      {
        "name": "Email Registration",
        "description": "Register with name, specialization, clinic, email, password. GDPR consent required. Sends confirmation email.",
        "files": [
          "src/app/(auth)/registracija/page.tsx",
          "src/components/auth/auth-provider.tsx"
        ],
        "entry_route": "/registracija",
        "user_interactions": [
          "Fill full name input",
          "Fill specialization input",
          "Fill clinic name input",
          "Fill email input",
          "Fill password input",
          "Fill confirm password input",
          "Check GDPR consent checkbox",
          "Click \"Registrujte se\" button",
          "See success screen with \"Provjerite email\" message"
        ],
        "api_calls": [
          {
            "method": "POST",
            "endpoint": "Supabase Auth signUp"
          }
        ],
        "auth_required": false
      },
      {
        "name": "Email Login",
        "description": "Login with email and password credentials",
        "files": [
          "src/app/(auth)/login/page.tsx",
          "src/components/auth/auth-provider.tsx"
        ],
        "entry_route": "/login",
        "user_interactions": [
          "Fill email input",
          "Fill password input",
          "Click \"Prijavite se\" button",
          "See error on invalid credentials",
          "Redirect to /dashboard on success"
        ],
        "api_calls": [
          {
            "method": "POST",
            "endpoint": "Supabase Auth signInWithPassword"
          }
        ],
        "auth_required": false
      },
      {
        "name": "Google OAuth Login",
        "description": "Login or register via Google OAuth",
        "files": [
          "src/components/auth/google-button.tsx",
          "src/components/auth/auth-provider.tsx",
          "src/app/auth/callback/route.ts"
        ],
        "entry_route": "/login",
        "user_interactions": [
          "Click \"Prijavi se putem Google-a\" button",
          "Google consent screen opens",
          "After approval, redirect to /dashboard"
        ],
        "api_calls": [
          {
            "method": "GET",
            "endpoint": "Supabase Auth signInWithOAuth (Google)"
          }
        ],
        "auth_required": false
      },
      {
        "name": "Email Confirmation Flow",
        "description": "After registration, user receives confirmation email. Clicking the link redirects to /auth/callback which exchanges code for session and redirects to /dashboard.",
        "files": [
          "src/app/(auth)/registracija/page.tsx",
          "src/app/auth/callback/route.ts",
          "middleware.ts"
        ],
        "entry_route": "/auth/callback",
        "user_interactions": [
          "Click confirmation link in email",
          "Automatically redirected to /dashboard",
          "Onboarding wizard appears for new users"
        ],
        "api_calls": [
          {
            "method": "GET",
            "endpoint": "/auth/callback (exchanges code for Supabase session)"
          }
        ],
        "auth_required": false
      },
      {
        "name": "Onboarding Wizard",
        "description": "Multi-step wizard shown to new users after email confirmation. 4 steps - doctor info (mandatory), clinic info (skippable), report sections (mandatory), branding uploads (skippable).",
        "files": [
          "src/components/auth/profile-completion-modal.tsx",
          "src/components/layout/app-shell.tsx"
        ],
        "entry_route": "/dashboard",
        "user_interactions": [
          "Step 1 - Fill doctor name and specialization (required)",
          "Click Next to advance",
          "Step 2 - Optionally fill clinic name, address, phone, website",
          "Click Skip or Next",
          "Step 3 - Configure report categories (add/remove/reorder)",
          "Click Next (at least 1 category required)",
          "Step 4 - Optionally upload logo, stamp, signature images",
          "Click \"Završi\" to complete onboarding",
          "Click Back to go to previous step"
        ],
        "api_calls": [
          {
            "method": "PATCH",
            "endpoint": "Supabase profiles table update"
          },
          {
            "method": "POST",
            "endpoint": "Supabase Storage upload (branding bucket)"
          }
        ],
        "auth_required": true
      },
      {
        "name": "Password Reset",
        "description": "Request password reset email and set new password",
        "files": [
          "src/app/(auth)/reset-password/page.tsx"
        ],
        "entry_route": "/reset-password",
        "user_interactions": [
          "Fill email input",
          "Click reset button",
          "Receive email with reset link",
          "Set new password"
        ],
        "api_calls": [
          {
            "method": "POST",
            "endpoint": "Supabase Auth resetPasswordForEmail"
          }
        ],
        "auth_required": false
      },
      {
        "name": "Dashboard",
        "description": "Main dashboard showing report statistics, recent reports, and quick action buttons",
        "files": [
          "src/app/dashboard/page.tsx"
        ],
        "entry_route": "/dashboard",
        "user_interactions": [
          "View report count and statistics",
          "Click on recent reports",
          "Click quick action buttons (new report, patients, settings)"
        ],
        "api_calls": [
          {
            "method": "GET",
            "endpoint": "Supabase reports table query"
          }
        ],
        "auth_required": true
      },
      {
        "name": "New Medical Report (Dictation)",
        "description": "Record audio dictation which is transcribed via n8n webhook into structured medical report sections",
        "files": [
          "src/app/novi-nalaz/page.tsx",
          "src/components/recording/dictation-flow.tsx",
          "src/components/recording/live-waveform.tsx",
          "src/components/report/section-card.tsx"
        ],
        "entry_route": "/novi-nalaz",
        "user_interactions": [
          "Click record button to start audio recording",
          "Speak medical dictation",
          "Click stop to end recording",
          "Wait for transcription processing",
          "Review and edit generated report sections",
          "Export as PDF or Word",
          "Copy for HIS system"
        ],
        "api_calls": [
          {
            "method": "POST",
            "endpoint": "/api/submit (n8n webhook proxy)"
          }
        ],
        "auth_required": true
      },
      {
        "name": "Report History",
        "description": "Browse and search past medical reports",
        "files": [
          "src/app/historija/page.tsx"
        ],
        "entry_route": "/historija",
        "user_interactions": [
          "View list of past reports",
          "Search reports by patient name or content",
          "Filter reports",
          "Click report to view details"
        ],
        "api_calls": [
          {
            "method": "GET",
            "endpoint": "Supabase reports table query"
          }
        ],
        "auth_required": true
      },
      {
        "name": "Patient Management",
        "description": "Manage patient records - add, edit, view patients",
        "files": [
          "src/app/pacijenti/page.tsx",
          "src/components/patient/patient-form.tsx"
        ],
        "entry_route": "/pacijenti",
        "user_interactions": [
          "View patient list",
          "Click add new patient",
          "Fill patient form (name, date of birth, contact)",
          "Save patient",
          "Edit existing patient"
        ],
        "api_calls": [
          {
            "method": "GET",
            "endpoint": "Supabase patients table query"
          },
          {
            "method": "POST",
            "endpoint": "Supabase patients table insert"
          },
          {
            "method": "PATCH",
            "endpoint": "Supabase patients table update"
          }
        ],
        "auth_required": true
      },
      {
        "name": "Settings",
        "description": "Configure doctor profile, clinic info, report categories, branding (logo/stamp/signature), and account management",
        "files": [
          "src/app/postavke/page.tsx",
          "src/lib/report-storage.ts"
        ],
        "entry_route": "/postavke",
        "user_interactions": [
          "Edit doctor name and specialization",
          "Edit clinic name, address, phone, website",
          "Add/remove/reorder report categories",
          "Upload logo, stamp, signature images",
          "Delete account"
        ],
        "api_calls": [
          {
            "method": "PATCH",
            "endpoint": "Supabase profiles table update"
          },
          {
            "method": "POST",
            "endpoint": "Supabase Storage upload (branding bucket)"
          },
          {
            "method": "DELETE",
            "endpoint": "/api/account/delete"
          }
        ],
        "auth_required": true
      },
      {
        "name": "Protected Route Middleware",
        "description": "Middleware redirects unauthenticated users to /login and authenticated users away from public pages to /dashboard. Auth callback route is excluded from checks.",
        "files": [
          "middleware.ts"
        ],
        "entry_route": "/",
        "user_interactions": [
          "Navigate to any protected route without login",
          "Get redirected to /login",
          "Navigate to login page while authenticated",
          "Get redirected to /dashboard"
        ],
        "api_calls": [],
        "auth_required": false
      }
    ],
    "known_limitations": [
      {
        "issue": "Google OAuth tests require a real Google account or OAuth simulation",
        "location": "src/components/auth/google-button.tsx",
        "impact": "Cannot fully automate Google OAuth flow without test credentials"
      },
      {
        "issue": "Audio dictation requires microphone access",
        "location": "src/components/recording/dictation-flow.tsx",
        "impact": "Dictation tests need browser microphone permission mocking"
      },
      {
        "issue": "Email confirmation link requires actual email delivery",
        "location": "src/app/(auth)/registracija/page.tsx",
        "impact": "Cannot test full email confirmation flow without email access or Supabase test hooks"
      }
    ]
  }
}
